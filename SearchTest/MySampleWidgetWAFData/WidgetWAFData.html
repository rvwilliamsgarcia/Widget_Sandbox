/*
	Modification of SampleWidgetWAFData code to perform search of logical simulation objects using
	Logical Web Services 1.1.0 OAS3.
	
	Refer to http://media.3ds.com/support/documentation/developer/R2022x/en/DSDocNS.htm?show=CAALogicalWS/dslog_v1.htm
*/

<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:widget="http://www.netvibes.com/ns/">

<head>
	<title>DSIS Sample Widget Get Data</title>

	<meta name="author" content="DSIS" />
	<meta name="description" content="DSIS Sample Widget WAFData" />
	<meta name="apiVersion" content="1.3" />
	<meta name="debugMode" content="true" />
	<meta name="strictMode" content="false" />

	<!-- <script type="text/javascript" src="../DSISLibraries/jquery/jquery-3.2.1.min.js"></script> -->
	<script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
	<!-- <script type="text/javascript" src="https://vm3dx22.corp.capgemini.com:9380/distrib_CAS/3dspace/webapps/VENENO6WPlugins/plugins/jquery/3.3.1/jquery.js"></script>-->
	
	<!-- Application Preferences -->
	<widget:preferences>
		<widget:preference type="text" name="urlREST" label="URL REST Service" defaultValue='https://vm3dx22.corp.capgemini.com:9380/3dspace/resources/v1/modeler/dslog/dslog:LogItem/search' />
		<widget:preference type="text" name="ctx" label="3DSpace Context" defaultValue='VPLMProjectLeader.TLI-JN.TLI Space' />
		<widget:preference type="text" name="typeObj" label="Type of Object" defaultValue='Simulation' />
	</widget:preferences>
	

	<!-- Widget files -->
	<!-- <link rel="stylesheet" type="text/css" href="styles/Main.css" />-->
	
	<style>
		p {
		    border-bottom: 1px solid grey;
		}
		
		table {
		    border: 1px solid grey;
		}
		
		th {
		    font-weight: bold;
		}
		
		td,
		th {
		    border: 1px solid grey;
		    padding: 5px;
		}
	</style>

	<!-- <script type="text/javascript" src="scripts/Main.js"></script>-->
	<script type="text/javascript">
	function executeWidgetCode() {
    require(["UWA/Drivers/jQuery", "DS/WAFData/WAFData"], function($, WAFData) {
        var myWidget = {
            dataFull: [],

            displayData: function(arrData) {
				console.log("displayData");
                var tableHTML =
                    "<div style='height:100%;overflow:auto;'><table><thead><tr><th>Type</th><th>Name</th><th>Revision</th><th>State</th></tr></thead><tbody>";

                for (var i = 0; i < arrData.length; i++) {
                    tableHTML =
                        tableHTML +
                        "<tr><td>" +
                        arrData[i].type +
                        "</td><td>" +
                        arrData[i].name +
                        "</td><td>" +
                        arrData[i].revision +
                        "</td><td>" +
                        arrData[i].current +
                        "</td></tr>";
                }

                tableHTML += "</tbody></table></div>";

                widget.body.innerHTML = tableHTML;
            },

            onLoadWidget: function() {
				console.log("on load");
                myWidget.callData();
                myWidget.displayData(myWidget.dataFull);
            },

            onSearchWidget: function(searchQuery) {
				console.log("on search");
                var arrResult = [];
                for (var i = 0; i < myWidget.dataFull.length; i++) {
                    var objData = myWidget.dataFull[i];
                    
                    if (objData.name.indexOf(searchQuery) !== -1) {
						console.log(objData.name);
                        arrResult.push(objData);
                    }
                }
                myWidget.displayData(arrResult);
            },

            onResetSearchWidget: function() {
				console.log("reset search");
                myWidget.displayData(myWidget.dataFull);
            },

            callData: function() {
                var urlWAF = widget.getValue("urlREST");
                var dataWAF = {
                   type: widget.getValue("typeObj"),
                   selects: "attribute[*],current,name,revision"
                };
                var headerWAF = {
                   SecurityContext: widget.getValue("ctx")
                };
                var methodWAF = "GET";
                WAFData.authenticatedRequest(urlWAF, {
					method: methodWAF,
					headers: headerWAF,
					data: dataWAF,
					type: "json",
					onComplete: function(dataResp) {
						console.log(dataResp.msg);
						if (dataResp.msg === "OK") {
							console.log("ok");
							myWidget.dataFull = dataResp.data;
							myWidget.displayData(myWidget.dataFull);
						} else {
							console.log("error in webservice response");
							widget.body.innerHTML += "<p>Error in WebService Response</p>";
							widget.body.innerHTML += "<p>" + JSON.stringify(dataResp) + "</p>";
						}
					},
					onFailure: function(error) {
						console.log("call failure");
						widget.body.innerHTML += "<p>Call Failure</p>";
						widget.body.innerHTML += "<p>" + JSON.stringify(error) + "</p>";
					}
                });
            }
        };

        widget.addEvent("onLoad", myWidget.onLoadWidget);
        widget.addEvent("onRefresh", myWidget.onLoadWidget);
        widget.addEvent("onSearch", myWidget.onSearchWidget);
        widget.addEvent("onResetSearch", myWidget.onResetSearchWidget);
    });
}
</script>

	<script type="text/javascript">
		function widgetLoading() {
			if (widget) {
				executeWidgetCode();
			} else {
				console.warn("Deferred widget Loading");
				setTimeout(widgetLoading, 100); //Wait for widget object to be added correctly
			}
		}
		widgetLoading();
	</script>

</head>

<body>
	<p>Loading...</p>
</body>

</html>